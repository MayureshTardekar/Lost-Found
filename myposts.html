<!DOCTYPE html>
<html lang="en"><head>
<script src="theme.js"></script>
<meta charset="utf-8"/>
<title>Stitch Design</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter:wght@400;500;700;900&amp;family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#7C3AED",
            "background-light": "#f7f6f8",
            "background-dark": "#000000",
            "card-light": "#FFFFFF",
            "card-dark": "#111111",
            "text-light": "#111827",
            "text-dark": "#F9FAFB",
            "text-muted-light": "#6B7280",
            "text-muted-dark": "#9CA3AF",
            "border-light": "#E5E7EB",
            "border-dark": "#374151"
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.75rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
          boxShadow: {
            'glow-primary': '0 0 15px 5px rgba(124, 58, 237, 0.5)',
          }
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="relative flex min-h-screen w-full flex-col">
<header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800">
<div class="flex items-center justify-between px-6 py-4 w-full">
  <!-- Logo on LEFT -->
  <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition flex-shrink-0">
    <span class="material-symbols-outlined text-purple-500 text-3xl">inventory_2</span>
    <h1 class="text-xl font-bold text-purple-500">Lost & Found</h1>
  </a>
  
  <!-- Spacer -->
  <div class="flex-grow"></div>
  
  <!-- Right side actions -->
  <div class="flex items-center space-x-3 flex-shrink-0">
    <!-- Theme Toggle -->
    <button id="themeToggle" class="flex items-center justify-center w-10 h-10 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition" title="Toggle Theme">
      <span class="material-symbols-outlined text-gray-600 dark:text-gray-400" id="themeIcon">dark_mode</span>
    </button>
    <!-- Add button -->
    <a href="report.html" class="flex items-center justify-center w-10 h-10 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition shadow-lg" title="Report Item">
      <span class="material-symbols-outlined">add</span>
    </a>
    <!-- Admin Panel button (only for admins) -->
    <a href="admin.html" id="adminBtn" class="hidden flex items-center justify-center w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full hover:shadow-lg transition shadow-md" title="Admin Dashboard">
      <span class="material-symbols-outlined">admin_panel_settings</span>
    </a>
    <!-- Profile menu -->
    <div class="relative" id="profileMenu">
      <button id="profileBtn" class="flex items-center justify-center w-10 h-10 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition" title="Profile Menu">
        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">person</span>
      </button>
      <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 hidden">
        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Profile</a>
        <a href="myposts.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">My Posts</a>
        <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Logout</button>
      </div>
    </div>
  </div>
</div>
</header>
<main class="flex-grow p-4">
<section id="my-posts">
<div id="myposts-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
<!-- Dynamic posts will load here -->
</div>
</section>
<section class="mt-8" id="admin-panel">
<h2 class="text-xl font-bold mb-4 px-1">Admin Panel</h2>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
<a class="group flex items-center gap-4 p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark transition-all duration-300 hover:border-primary hover:shadow-glow-primary" href="#">
<div class="p-2 bg-primary/10 rounded-full text-primary">
<span class="material-symbols-outlined">inventory_2</span>
</div>
<h3 class="font-bold">Manage Items</h3>
</a>
<a class="group flex items-center gap-4 p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark transition-all duration-300 hover:border-primary hover:shadow-glow-primary" href="#">
<div class="p-2 bg-primary/10 rounded-full text-primary">
<span class="material-symbols-outlined">group</span>
</div>
<h3 class="font-bold">Manage Users</h3>
</a>
</div>
</section>
</main>
<footer class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-300 mt-12 border-t-2 border-purple-500">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div>
        <h3 class="text-purple-600 dark:text-purple-400 font-bold text-lg mb-3 flex items-center gap-2">
          <span class="material-symbols-outlined">school</span>
          SPIT Lost & Found
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Connecting students with lost & found items.</p>
      </div>
      <div>
        <h3 class="text-purple-600 dark:text-purple-400 font-bold text-lg mb-3 flex items-center gap-2">
          <span class="material-symbols-outlined">contact_mail</span>
          Contact
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          <a href="mailto:info@spit.ac.in" class="text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300">info@spit.ac.in</a>
        </p>
      </div>
      <div>
        <h3 class="text-purple-600 dark:text-purple-400 font-bold text-lg mb-3 flex items-center gap-2">
          <span class="material-symbols-outlined">link</span>
          Quick Links
        </h3>
        <ul class="text-sm text-gray-700 dark:text-gray-400 space-y-2">
          <li><a href="index.html" class="hover:text-purple-600 dark:hover:text-purple-400 transition flex items-center gap-1"><span class="material-symbols-outlined text-xs">chevron_right</span> Browse Items</a></li>
          <li><a href="report.html" class="hover:text-purple-600 dark:hover:text-purple-400 transition flex items-center gap-1"><span class="material-symbols-outlined text-xs">chevron_right</span> Report Item</a></li>
          <li><a href="profile.html" class="hover:text-purple-600 dark:hover:text-purple-400 transition flex items-center gap-1"><span class="material-symbols-outlined text-xs">chevron_right</span> Profile</a></li>
        </ul>
      </div>
    </div>
    <div class="border-t border-gray-300 dark:border-gray-800 mt-8 pt-6 text-center">
      <p class="text-sm text-gray-600 dark:text-gray-500">¬© 2025 Sardar Patel Institute of Technology. All rights reserved.</p>
    </div>
  </div>
</footer>
<script src="auth.js"></script>
<script>
// Load user's posts dynamically
document.addEventListener('DOMContentLoaded', async () => {
  const currentUser = JSON.parse(localStorage.getItem('campus_lost_found_current_user'));
  
  if (!currentUser) {
    window.location.href = 'login.html';
    return;
  }

  const container = document.getElementById('myposts-container');
  
  try {
    // Load user posts from MySQL API
    const response = await fetch(`/api/myposts/${currentUser.id}`);
    const userPosts = await response.json();
    
    if (userPosts.length === 0) {
      container.innerHTML = `
        <div class="col-span-2 text-center py-12 text-gray-400">
          <p class="text-lg">No posts yet</p>
          <a href="report.html" class="inline-block mt-4 px-6 py-2 bg-primary rounded-lg text-white hover:bg-primary/80 transition">
            Report an Item
          </a>
        </div>
      `;
      return;
    }

    userPosts.forEach(post => {
    const postCard = document.createElement('div');
    const isResolved = post.status === 'Resolved' || post.status === 'Claimed';
    postCard.className = `group relative flex flex-col rounded-lg overflow-hidden transition-all duration-300 transform hover:-translate-y-1 hover:shadow-glow-primary bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark ${isResolved ? 'opacity-75' : ''}`;
    
    const imageUrl = post.image_url || post.image || 'https://via.placeholder.com/300x400/1a1a2e/a855f7?text=No+Image';
    const hasNoImage = !post.image_url && !post.image;
    const dateString = post.created_at ? new Date(post.created_at).toLocaleDateString() : (post.date ? new Date(post.date).toLocaleDateString() : 'N/A');
    const locationText = post.location_text || post.location || 'N/A';
    
    // Type badge color
    const typeColor = post.type === 'Lost' ? 'bg-red-500' : 'bg-green-500';
    
    postCard.innerHTML = `
      <div class="w-full aspect-[4/5] bg-cover bg-center relative" style="background-image: url('${imageUrl}');">
        ${hasNoImage ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(124, 58, 237, 0.9); padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; color: white;">No Image</div>' : ''}
        <!-- Type Badge -->
        <div class="absolute top-2 left-2">
          <span class="px-2 py-1 text-xs font-bold text-white ${typeColor} rounded-full">${post.type}</span>
        </div>
        <!-- Status Badge -->
        ${isResolved ? '<div class="absolute top-2 left-16"><span class="px-2 py-1 text-xs font-bold text-white bg-blue-600 rounded-full">‚úì Resolved</span></div>' : ''}
      </div>
      <div class="p-3 flex-grow">
        <p class="font-semibold text-sm leading-tight line-clamp-2">${post.title}</p>
        <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">üìÖ ${dateString}</p>
        <p class="text-xs text-text-muted-light dark:text-text-muted-dark">üìç ${locationText}</p>
      </div>
      <div class="absolute top-2 right-2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
        ${!isResolved ? `
          ${post.type === 'Found' ? `
            <button onclick="viewClaims(${post.id}, '${post.title.replace(/'/g, "\\'")}', '${post.type}')" class="p-1.5 rounded-full bg-blue-500/20 text-blue-400 transition-all duration-200 hover:bg-blue-500/40" title="View Claims">
              <span class="material-symbols-outlined text-sm">how_to_reg</span>
            </button>
            <button onclick="markAsResolved(${post.id}, 'Found')" class="p-1.5 rounded-full bg-green-500/20 text-green-400 transition-all duration-200 hover:bg-green-500/40" title="Mark as Claimed">
              <span class="material-symbols-outlined text-sm">check_circle</span>
            </button>
          ` : `
            <button onclick="markAsResolved(${post.id}, 'Lost')" class="p-1.5 rounded-full bg-green-500/20 text-green-400 transition-all duration-200 hover:bg-green-500/40" title="Mark as Found">
              <span class="material-symbols-outlined text-sm">check_circle</span>
            </button>
          `}
          <button onclick="editPost(${post.id})" class="p-1.5 rounded-full bg-primary/20 text-primary transition-all duration-200 hover:bg-primary/40 hover:shadow-glow-primary" title="Edit">
            <span class="material-symbols-outlined text-sm">edit</span>
          </button>
        ` : ''}
        <button onclick="deletePost(${post.id})" class="p-1.5 rounded-full bg-red-500/20 text-red-500 transition-all duration-200 hover:bg-red-500/40" title="Delete">
          <span class="material-symbols-outlined text-sm">delete</span>
        </button>
      </div>
    `;
    
    container.appendChild(postCard);
  });

  } catch (error) {
    console.error('Error loading posts:', error);
    container.innerHTML = `
      <div class="col-span-2 text-center py-12 text-red-400">
        <p class="text-lg">Error loading posts</p>
      </div>
    `;
  }
  
  // Hide admin panel if not admin
  if (currentUser.role !== 'admin') {
    const adminPanel = document.getElementById('admin-panel');
    if (adminPanel) adminPanel.style.display = 'none';
  } else {
    // Show admin button if user is admin
    const adminBtn = document.getElementById('adminBtn');
    if (adminBtn) {
      adminBtn.classList.remove('hidden');
      adminBtn.classList.add('flex');
    }
  }
  
  // Profile dropdown toggle
  const profileBtn = document.getElementById('profileBtn');
  const profileDropdown = document.getElementById('profileDropdown');
  
  if (profileBtn && profileDropdown) {
    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      profileDropdown.classList.add('hidden');
    });
  }
  
  // Logout button
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('campus_lost_found_current_user');
      localStorage.removeItem('campus_lost_found_login_time');
      window.location.href = 'home.html';
    });
  }
  
  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  
  if (themeToggle && themeIcon) {
    // Set initial icon
    const isDark = document.documentElement.classList.contains('dark');
    themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
    
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');
      
      if (isDark) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('campus_lost_found_theme', 'light');
        themeIcon.textContent = 'dark_mode';
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('campus_lost_found_theme', 'dark');
        themeIcon.textContent = 'light_mode';
      }
    });
  }
});

// Delete post function
async function deletePost(postId) {
  if (!confirm('Are you sure you want to delete this post?')) return;
  
  try {
    const response = await fetch(`/api/items/${postId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Post deleted successfully!');
      location.reload();
    } else {
      alert('Failed to delete post');
    }
  } catch (error) {
    alert('Error deleting post: ' + error.message);
  }
}

// Edit post function (simplified - full edit feature can be added later)
function editPost(postId) {
  alert('Edit functionality: You can redirect to an edit page or open a modal. For now, please delete and create a new post.');
  // TODO: Implement full edit functionality with API endpoint
  return;
  
  const newTitle = prompt('Edit Title:', post.title);
  if (newTitle && newTitle.trim()) {
    post.title = newTitle.trim();
    localStorage.setItem('campus_lost_found_posts', JSON.stringify(posts));
    alert('Post updated successfully!');
    location.reload();
  }
}

// View claims function
async function viewClaims(itemId, itemTitle, itemType) {
  try {
    const response = await fetch(`/api/items/${itemId}/claims`);
    const claims = await response.json();
    
    document.getElementById('claimsItemTitle').textContent = itemTitle;
    const claimsContainer = document.getElementById('claimsContainer');
    
    if (claims.length === 0) {
      claimsContainer.innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <span class="material-symbols-outlined text-4xl mb-2 opacity-50">pending_actions</span>
          <p>No claims yet</p>
        </div>
      `;
    } else {
      claimsContainer.innerHTML = '';
      claims.forEach(claim => {
        const claimCard = document.createElement('div');
        claimCard.className = 'bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-3';
        
        const statusColors = {
          'Pending': 'text-yellow-400 bg-yellow-400/10',
          'Approved': 'text-green-400 bg-green-400/10',
          'Rejected': 'text-red-400 bg-red-400/10'
        };
        
        claimCard.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-grow">
              <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-purple-400">person</span>
                <span class="font-semibold text-white">${claim.claimant_name}</span>
              </div>
              <p class="text-sm text-gray-400 mb-1">üìß ${claim.claimant_email}</p>
              <p class="text-sm text-gray-300 whitespace-pre-wrap">${claim.message || 'No message provided'}</p>
              ${claim.proof_image ? `<img src="${claim.proof_image}" class="mt-2 max-w-xs rounded-lg border border-purple-500/30" alt="Proof">` : ''}
              <p class="text-xs text-gray-500 mt-2">üìÖ ${new Date(claim.created_at).toLocaleString()}</p>
            </div>
            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColors[claim.status]}">${claim.status}</span>
          </div>
          ${claim.status === 'Pending' ? `
            <div class="flex gap-2 pt-2 border-t border-gray-700">
              <button onclick="approveClaim(${claim.id}, ${itemId})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                ‚úì Approve & Mark Claimed
              </button>
              <button onclick="rejectClaim(${claim.id})" class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition">
                ‚úó Reject
              </button>
            </div>
          ` : ''}
        `;
        
        claimsContainer.appendChild(claimCard);
      });
    }
    
    document.getElementById('claimsModal').classList.remove('hidden');
  } catch (error) {
    console.error('Error loading claims:', error);
    alert('Error loading claims. Please try again.');
  }
}

function closeClaimsModal() {
  document.getElementById('claimsModal').classList.add('hidden');
}

// Approve claim
async function approveClaim(claimId, itemId) {
  if (!confirm('Approve this claim and mark the item as resolved?')) return;
  
  try {
    const response = await fetch(`/api/claims/${claimId}/approve`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: itemId })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Claim approved! Item marked as claimed.');
      closeClaimsModal();
      location.reload();
    } else {
      alert('Failed to approve claim: ' + result.message);
    }
  } catch (error) {
    console.error('Error approving claim:', error);
    alert('Error approving claim. Please try again.');
  }
}

// Reject claim
async function rejectClaim(claimId) {
  if (!confirm('Reject this claim?')) return;
  
  try {
    const response = await fetch(`/api/claims/${claimId}/reject`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Claim rejected.');
      closeClaimsModal();
      location.reload();
    } else {
      alert('Failed to reject claim: ' + result.message);
    }
  } catch (error) {
    console.error('Error rejecting claim:', error);
    alert('Error rejecting claim. Please try again.');
  }
}

// Mark item as resolved
async function markAsResolved(itemId, type) {
  const confirmMessage = type === 'Found' 
    ? 'Mark this Found item as Claimed?' 
    : 'Mark this Lost item as Found?';
  
  if (!confirm(confirmMessage)) return;
  
  try {
    const response = await fetch(`/api/items/${itemId}/resolve`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const result = await response.json();
    
    if (result.success) {
      const successMessage = type === 'Found' 
        ? 'Item marked as claimed!' 
        : 'Item marked as found!';
      alert(successMessage);
      location.reload();
    } else {
      alert('Failed to update status: ' + result.message);
    }
  } catch (error) {
    console.error('Error marking as resolved:', error);
    alert('Error updating status. Please try again.');
  }
}
</script>

<!-- Claims Modal -->
<div id="claimsModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="bg-gray-900 rounded-2xl border border-purple-500/30 max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
    <div class="p-6 border-b border-gray-800 flex items-center justify-between">
      <div>
        <h3 class="text-2xl font-bold text-purple-400">Claims</h3>
        <p class="text-gray-400 text-sm mt-1">Item: <span class="font-semibold text-white" id="claimsItemTitle"></span></p>
      </div>
      <button onclick="closeClaimsModal()" class="text-gray-400 hover:text-white transition">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div id="claimsContainer" class="p-6 overflow-y-auto max-h-[60vh] space-y-4">
      <!-- Claims will be loaded here -->
    </div>
  </div>
</div>

</div>

</body></html>
